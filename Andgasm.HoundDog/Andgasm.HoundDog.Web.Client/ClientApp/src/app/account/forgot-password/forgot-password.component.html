<div class="row">

  <div class="col-md-12">

    <div class="card">

      <div class="card-header bg-white pl-0 pt-1">
        <h4 *ngIf="currentStepName=='AccountId'" class="card-title">Forgotten Password Process - Identification</h4>
        <h4 *ngIf="currentStepName=='2FA'" class="card-title">Forgotten Password Process - 2FA</h4>
      </div>

      <div class="card-block">

        <div class="alert alert-info mt-3">
          <p>
            If you cannot remember your account password we can initiate the password reset process for you using the form below.
            Once you have submitted your username, email address and passed 2FA checks we will email a password reset link to your registered email account which you must follow in order to complete the process.
          </p>
          <p>
            Note that if your account is protected by Two-Factor Authentication (2FA) then you will have to enter a one time verification code generated by your registered authenticator application in order to initiate the password reset process.
            If you cannot complete the 2FA verification process due to a lost or unconfigured authenticator device you must follow the account recovery process.
          </p>
        </div>

        <form #f="ngForm" novalidate (ngSubmit)="sendPasswordReset(f)">

          <div class="form-group mt-3">
            <ng-template #userNameTipContent>Enter the username of the account you wish to reset the password for.</ng-template>
            <img src="../../assets/icons/question_small_icon.png" class="mr-1" [ngbTooltip]="userNameTipContent" />
            <label for="username">Username</label>
            <input id="username" type="text" required name="username" tmFocus class="form-control" placeholder="Username"
                    [ngClass]="{'is-invalid': (errors.UserName || !username.valid && !username.pristine), 'is-valid': !errors.UserName && username.valid && submitted}"
                    [(ngModel)]="credentials.username" #username="ngModel">
            <small *ngIf="errors.username" class="text-danger">{{errors.username}}</small>
            <small [hidden]="username.valid || (username.pristine && !submitted)" class="text-danger">Username must be between 6 and 16 characters in length</small>
          </div>

          <div class="form-group mt-3">
            <ng-template #emailTipContent>Enter the email address of the account you wish to reset the password for. This address must match the address associated with the username in order to process the reset request.</ng-template>
            <img src="../../assets/icons/question_small_icon.png" class="mr-1" [ngbTooltip]="emailTipContent" />
            <label for="email">Email</label>
            <input id="email" type="text" required name="email" validateEmail class="form-control" placeholder="Email"
                    [ngClass]="{'is-invalid': (errors.Email || !email.valid && !email.pristine), 'is-valid': !errors.Email && email.valid && submitted}"
                    [(ngModel)]="credentials.email" #email="ngModel">
            <small [hidden]="email.valid || (email.pristine && !submitted)" class="text-danger">Please enter a valid email</small>
            <small *ngIf="errors.Email" class="text-danger">{{errors.Email}}</small>
          </div>

          <div *ngIf="requires2fachallenge" class="form-group mt-3">
            <div class="alert alert-warning">
              <p for="user-name">
                Because your account is protected by 2FA you must enter the code that was generated by your authenticator app to reset your password.
              </p>
              <p> If you have no access to your authenticator you must follow the account recovery process.</p>
            </div>
            <div>
              <ng-template #verifyCodeTipContent>Enter the verification code generated by your authenticator app.</ng-template>
              <img src="../../assets/icons/question_small_icon.png" class="mr-1" [ngbTooltip]="verifyCodeTipContent" />
              <label for="password">Verification Code</label>
              <input id="verificationCode" type="text" name="verificationCode" required class="form-control" placeholder="Verification Code" [disabled]="errors.length > 0"
                     [ngClass]="{'is-invalid': (errors.VerificationCode || !verificationCode.valid && !verificationCode.pristine), 'is-valid': !errors.VerificationCode && verificationCode.valid && submitted}"
                     [(ngModel)]="credentials.verificationCode" #verificationCode="ngModel">
              <small *ngIf="errors.verificationCode" class="text-danger">{{errors.verificationCode}}</small>
            </div>
          </div>

          <div class="form-group text-right">
            <button type="button" (click)="cancelResetOperation()" class="btn btn-outline-secondary"><i class='fa fa-edit'></i>Cancel</button>&nbsp;
            <button *ngIf="currentStepName=='AccountId'" type="button" class="btn btn-primary" [disabled]="isRequesting" (click)="provideAccountIdentifier(f)">
              <app-spinner [isRunning]="isRequesting" [displayText]="'Sending Reset Request'"></app-spinner>
              <span [hidden]="isRequesting">Submit Reset Request</span>
            </button>
            <button *ngIf="currentStepName=='2FA'" type="submit" class="btn btn-primary" [disabled]="isRequesting">
              <app-spinner [isRunning]="isRequesting" [displayText]="'Sending Reset Request'"></app-spinner>
              <span [hidden]="isRequesting">Submit Reset Request</span>
            </button>
          </div>

          <div *ngIf="errors.ServerError" class="alert alert-danger" role="alert">
            <strong>The server returned the following errors...</strong> <br /> {{errors.ServerError}}
          </div>
        </form>

      </div>
    </div>
  </div>

</div>
